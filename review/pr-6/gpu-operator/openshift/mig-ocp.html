<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MIG Support in OpenShift Container Platform &mdash; NVIDIA Cloud Native Technologies  documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/copybutton.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/tabs.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/custom.css" type="text/css" />
    <link rel="shortcut icon" href="../../_static/nvidia.ico"/>
    <link rel="canonical" href="https://docs.nvidia.com/datacenter/cloud-native/gpu-operator/openshift/mig-ocp.html"/>
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
        <script src="../../_static/clipboard.min.js"></script>
        <script src="../../_static/copybutton.js"></script>
        <script src="../../_static/js/google-analytics/google-analytics-tracker.js"></script>
        <script src="../../_static/js/google-analytics/google-analytics-write.js"></script>
        <script src="//assets.adobedtm.com/b92787824f2e0e9b68dc2e993f9bd995339fe417/satelliteLib-7ba51e58dc61bcb0e9311aadd02a0108ab24cc6c.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Cleanup" href="clean-up.html" />
    <link rel="prev" title="NVIDIA AI Enterprise with OpenShift" href="nvaie-with-ocp.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" > 
            <a href="../../contents.html">
            <img src="../../_static/NVLogo_H_B&W.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

  <style>
    /* Sidebar header (and topbar for mobile) */
    .wy-side-nav-search, .wy-nav-top {
      background: #76b900;
    }

    .wy-side-nav-search a:link, .wy-nav-top a:link {
      color: #fff;
    }
    .wy-side-nav-search a:visited, .wy-nav-top a:visited {
      color: #fff;
    }
    .wy-side-nav-search a:hover, .wy-nav-top a:hover {
      color: #fff;
    }

    .wy-menu-vertical a:link, .wy-menu-vertical a:visited {
      color: #d9d9d9
    }

    .wy-menu-vertical a:active {
      background-color: #76b900
    }

    .wy-side-nav-search>div.version {
      color: rgba(0, 0, 0, 0.3)
    }

    .wy-nav-content {
      max-width: 1000px;
    }
  </style>
  
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">NVIDIA Container Toolkit:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../container-toolkit/overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../container-toolkit/concepts.html">Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../container-toolkit/arch-overview.html">Architecture Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../container-toolkit/install-guide.html">Installation Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../container-toolkit/troubleshooting.html">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../container-toolkit/user-guide.html">User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../container-toolkit/release-notes.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../container-toolkit/archive.html">Archive</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">NVIDIA GPU Operator:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting-started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../platform-support.html">Platform Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../release-notes.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gpu-driver-upgrades.html">GPU Driver Upgrades</a></li>
<li class="toctree-l1"><a class="reference internal" href="../install-gpu-operator-vgpu.html">NVIDIA vGPU</a></li>
<li class="toctree-l1"><a class="reference internal" href="../install-gpu-operator-nvaie.html">NVIDIA AI Enterprise</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="contents.html">GPU Operator on OpenShift</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="introduction.html">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="prerequisites.html">Prerequisites</a></li>
<li class="toctree-l2"><a class="reference internal" href="steps-overview.html">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="install-nfd.html">Installing the Node Feature Discovery (NFD) Operator</a></li>
<li class="toctree-l2"><a class="reference internal" href="install-gpu-ocp.html">Installing the NVIDIA GPU Operator</a></li>
<li class="toctree-l2"><a class="reference internal" href="nvaie-with-ocp.html">NVIDIA AI Enterprise with OpenShift</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">MIG Support in OpenShift Container Platform</a></li>
<li class="toctree-l2"><a class="reference internal" href="clean-up.html">Cleanup</a></li>
<li class="toctree-l2"><a class="reference internal" href="mirror-gpu-ocp-disconnected.html">Deploy GPU Operators in a disconnected or airgapped environment</a></li>
<li class="toctree-l2"><a class="reference internal" href="enable-gpu-op-dashboard.html">Enable the GPU Operator Dashboard</a></li>
<li class="toctree-l2"><a class="reference internal" href="time-slicing-gpus-in-openshift.html">Time-slicing NVIDIA GPUs in OpenShift</a></li>
<li class="toctree-l2"><a class="reference internal" href="openshift-virtualization.html">NVIDIA GPU Operator with OpenShift Virtualization</a></li>
<li class="toctree-l2"><a class="reference internal" href="troubleshooting-gpu-ocp.html">Troubleshooting</a></li>
<li class="toctree-l2"><a class="reference internal" href="appendix-ocp.html">Appendix</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../gpu-operator-mig.html">GPU Operator with MIG</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gpu-sharing.html">Time-Slicing GPUs in Kubernetes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gpu-operator-rdma.html">GPUDirect RDMA and GPUDirect Storage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gpu-operator-kubevirt.html">GPU Operator with KubeVirt</a></li>
<li class="toctree-l1"><a class="reference internal" href="../appendix.html">Appendix</a></li>
<li class="toctree-l1"><a class="reference internal" href="../archive.html">Archive</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Kubernetes with GPUs:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../kubernetes/install-k8s.html">Install Kubernetes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kubernetes/mig-k8s.html">MIG Support in Kubernetes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kubernetes/anthos-guide.html">NVIDIA GPUs with Google Cloud’s Anthos</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">GPU Telemetry:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../gpu-telemetry/dcgm-exporter.html">DCGM-Exporter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gpu-telemetry/dcgm-exporter.html#integrating-gpu-telemetry-into-kubernetes">Integrating GPU Telemetry into Kubernetes</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Multi-Instance GPU:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../mig/mig.html">Multi-Instance GPU</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mig/mig-k8s.html">MIG Support in Kubernetes</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Driver Containers:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../driver-containers/overview.html">Overview</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Playground:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../playground/dind.html">Docker-in-Docker</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../playground/x-arch.html">Running Cross-Architecture Containers</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../contents.html">NVIDIA Cloud Native Technologies</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../contents.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="contents.html">GPU Operator on OpenShift</a> &raquo;</li>
      <li>MIG Support in OpenShift Container Platform</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="mig-support-in-openshift-container-platform">
<span id="mig-ocp"></span><h1>MIG Support in OpenShift Container Platform<a class="headerlink" href="#mig-support-in-openshift-container-platform" title="Permalink to this heading"></a></h1>
<p>This document provides guidance on setting up Multi-Instance GPU (MIG) in an OpenShift Container Platform cluster.</p>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading"></a></h2>
<p>MIG is useful anytime you have an application that does not require the full power of an entire GPU.
The new NVIDIA Ampere architecture’s MIG feature allows you to split your hardware resources into multiple GPU instances, each exposed to the operating system as an independent CUDA-enabled GPU. The NVIDIA GPU Operator version 1.7.0 and above provides MIG feature support for the A100 and A30 Ampere cards.
These GPU instances are designed to support multiple independent CUDA applications (up to 7), so they operate completely isolated from each other using dedicated hardware resources.</p>
<p>The compute units of the GPU, in addition to its memory, can be partitioned into multiple MIG instances.
Each of these instances presents as a stand-alone GPU device from the system perspective and can be bound to any application, container, or virtual machine running on the node.</p>
<p>From the perspective of the software consuming the GPU each of these MIG instances looks like its own individual GPU.</p>
</section>
<section id="mig-geometry">
<h2>MIG geometry<a class="headerlink" href="#mig-geometry" title="Permalink to this heading"></a></h2>
<p>The NVIDIA GPU Operator version 1.7.0 and above enables OpenShift Container Platform administrators to dynamically reconfigure the geometry of the MIG partitioning.
The geometry of the MIG partitioning is how hardware resources are bound to MIG instances, so it directly influences their performance and the number of instances that can be allocated.
The A100-40GB, for example, has eight compute units and 40 GB of RAM. When the MIG mode is enabled, the eighth instance is reserved for resource management.</p>
<p>The table below provides a summary of the MIG instance properties of the NVIDIA A100-40GB product:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 19%" />
<col style="width: 22%" />
<col style="width: 21%" />
<col style="width: 37%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Profile</p></th>
<th class="head"><p>Memory</p></th>
<th class="head"><p>Compute Units</p></th>
<th class="head"><p>Maximum number
of homogeneous instances</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>1g.5gb</p></td>
<td><p>5 GB</p></td>
<td><p>1</p></td>
<td><p>7</p></td>
</tr>
<tr class="row-odd"><td><p>2g.10gb</p></td>
<td><p>10 GB</p></td>
<td><p>2</p></td>
<td><p>3</p></td>
</tr>
<tr class="row-even"><td><p>3g.20gb</p></td>
<td><p>20 GB</p></td>
<td><p>3</p></td>
<td><p>2</p></td>
</tr>
<tr class="row-odd"><td><p>4g.20gb</p></td>
<td><p>20 GB</p></td>
<td><p>4</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-even"><td><p>7g.40gb</p></td>
<td><p>40 GB</p></td>
<td><p>7</p></td>
<td><p>1</p></td>
</tr>
</tbody>
</table>
<p>In addition to homogeneous instances, some heterogeneous combinations can be chosen. See the <a class="reference external" href="https://docs.nvidia.com/datacenter/tesla/mig-user-guide/index.html">Multi-Instance GPU User Guide documentation</a> for an exhaustive listing.</p>
<p>Here is an example, again for the A100-40GB, with heterogeneous (or “mixed”) geometries:</p>
<ul class="simple">
<li><p>2x 1g.5gb</p></li>
<li><p>1x 2g.10gb</p></li>
<li><p>1x 3g.10gb</p></li>
</ul>
<section id="prerequisites">
<h3>Prerequisites<a class="headerlink" href="#prerequisites" title="Permalink to this heading"></a></h3>
<p>The deployment workflow requires these prerequisites.</p>
<ol class="arabic simple">
<li><p>You already have a OpenShift Container Platform cluster up and running with access to at least one MIG-capable GPU.</p></li>
<li><p>You have followed the guidance in <span class="xref std std-ref">NVIDIA documentation</span> proceeding as far as creating the <cite>cluster policy &lt;create-cluster-policy&gt;</cite>.</p></li>
</ol>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The node must be free (drained) of GPU workloads before any reconfiguration is triggered. For guidance on draining a node see, the OpenShift Container Platform documentation <a class="reference external" href="https://docs.openshift.com/container-platform/latest/nodes/nodes/nodes-nodes-working.html#nodes-nodes-working-evacuating_nodes-nodes-working">Understanding how to evacuate pods on nodes</a>.</p>
</div>
</section>
</section>
<section id="configuring-mig-devices-in-openshift">
<h2>Configuring MIG Devices in OpenShift<a class="headerlink" href="#configuring-mig-devices-in-openshift" title="Permalink to this heading"></a></h2>
<section id="mig-advertisement-strategies">
<h3>MIG advertisement strategies<a class="headerlink" href="#mig-advertisement-strategies" title="Permalink to this heading"></a></h3>
<p>The NVIDIA GPU Operator exposes GPUs to Kubernetes as extended resources that can be requested and exposed into Pods and containers. The first step of the MIG configuration is to decide what <strong>Strategy</strong> you want. The advertisement strategies are described here:</p>
<ul>
<li><p><strong>Single</strong> defines a homogeneous advertisement strategy, with MIG instances exposed as usual GPUs. This strategy exposes the MIG instances as <code class="docutils literal notranslate"><span class="pre">nvidia.com/gpu</span></code> resources, identically, as usual non-MIG capable (or with MIG disabled) devices. In this strategy, all the GPUs in a single node must be configured in a homogenous manner (same number of compute units, same memory size). This strategy is best for a large cluster where the infrastructure teams can configure “node pools” of different MIG geometries and make them available to users. Another advantage of this strategy is backward compatibility where the existing application does not have to be modified to be scheduled this way.</p>
<blockquote>
<div><p>Examples for the A100-40GB:</p>
<ul>
<li><p>1g.5gb:  7 nvidia.com/gpu instances, or</p></li>
<li><p>2g.10gb: 3 nvidia.com/gpu instances, or</p></li>
<li><p>3g.20gb: 2 nvidia.com/gpuinstances, or</p></li>
<li><p>7g.40gb: 1 nvidia.com/gpu instances</p>
<img alt="../../_images/Mig-profile-A1008.png" src="../../_images/Mig-profile-A1008.png" />
</li>
</ul>
</div></blockquote>
</li>
<li><p><strong>Mixed</strong> defines a heterogeneous advertisement strategy. There is no constraint on the geometry; all the combinations allowed by the GPU are permitted. This strategy is appropriate for a smaller cluster, where on a single node with multiple GPUs, each GPU can be configured in a different MIG geometry.</p>
<blockquote>
<div><p>Examples for the A100-40GB:</p>
<ul>
<li><p>All the <strong>single</strong> configurations are possible</p></li>
<li><p>A “balanced” configuration:</p>
<ul class="simple">
<li><p>1g.5gb:  2 nvidia.com/mig-1g.5gb instances, and</p></li>
<li><p>2g.10gb: 1 nvidia.com/mig-2g.10gb instance, and</p></li>
<li><p>3g.20gb: 1 nvidia.com/mig-3g.20gb instance</p></li>
</ul>
<img alt="../../_images/mig-mixed-profile-A1008.png" src="../../_images/mig-mixed-profile-A1008.png" />
</li>
</ul>
</div></blockquote>
</li>
</ul>
<p>Version 1.8 and greater of the NVIDIA GPU Operator supports updating the <strong>Strategy</strong> in the ClusterPolicy after deployment.</p>
<p>The <a class="reference external" href="https://gitlab.com/nvidia/kubernetes/gpu-operator/-/blob/v1.8.0/assets/state-mig-manager/0400_configmap.yaml">default configmap</a> defines the combination of single (homogeneous) and mixed (heterogeneous) profiles that are supported for A100-40GB, A100-80GB and A30-24GB. The configmap allows administrators to declaratively define a set of possible MIG configurations they would like applied to all GPUs on a node.
The tables below describe these configurations:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 22%" />
<col style="width: 26%" />
<col style="width: 26%" />
<col style="width: 26%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>GPU Type</p></th>
<th class="head"><p>Custom label</p></th>
<th class="head"><p>Profile</p></th>
<th class="head"><p>MIG instances</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>A100-40GB</p></td>
<td colspan="3"></td>
</tr>
<tr class="row-odd"><td></td>
<td><p>all-1g.5gb</p></td>
<td><p>1g.5gb</p></td>
<td><p>7</p></td>
</tr>
<tr class="row-even"><td></td>
<td><p>all-2g.10gb</p></td>
<td><p>2g.10gb</p></td>
<td><p>3</p></td>
</tr>
<tr class="row-odd"><td></td>
<td><p>all-3g.20gb</p></td>
<td><p>3g.20gb</p></td>
<td><p>2</p></td>
</tr>
<tr class="row-even"><td></td>
<td><p>all-7g.40gb</p></td>
<td><p>7g.40gb</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-odd"><td><p>A100-80GB</p></td>
<td colspan="3"></td>
</tr>
<tr class="row-even"><td></td>
<td><p>all-1g.10gb</p></td>
<td><p>1g.10gb</p></td>
<td><p>7</p></td>
</tr>
<tr class="row-odd"><td></td>
<td><p>all-2g.20gb</p></td>
<td><p>2g.20gb</p></td>
<td><p>3</p></td>
</tr>
<tr class="row-even"><td></td>
<td><p>all-3g.40gb</p></td>
<td><p>3g.40gb</p></td>
<td><p>2</p></td>
</tr>
<tr class="row-odd"><td></td>
<td><p>all-7g.80gb</p></td>
<td><p>7g.80gb</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-even"><td><p>A30-24GB</p></td>
<td colspan="3"></td>
</tr>
<tr class="row-odd"><td></td>
<td><p>all-1g.6gb</p></td>
<td><p>1g.6gb</p></td>
<td><p>4</p></td>
</tr>
<tr class="row-even"><td></td>
<td><p>all-2g.12gb</p></td>
<td><p>2g.12gb</p></td>
<td><p>2</p></td>
</tr>
<tr class="row-odd"><td></td>
<td><p>all-4g.24gb</p></td>
<td><p>4g.24gb</p></td>
<td><p>1</p></td>
</tr>
</tbody>
</table>
<p>All-balanced is composed of 3 distinct configurations, with a <cite>device-filter</cite> filtering, based on the device UID. The possible supported combinations are described below:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 24%" />
<col style="width: 27%" />
<col style="width: 49%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>GPU Type</p></th>
<th class="head"><p>Custom label</p></th>
<th class="head"><p>Profile and MIG instances</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>A100-40GB</p></td>
<td colspan="2"></td>
</tr>
<tr class="row-odd"><td></td>
<td><p>all-balanced</p></td>
<td><p>1g.5gb: 2</p>
<p>2g.10gb:1</p>
<p>3g.20gb:1</p>
</td>
</tr>
<tr class="row-even"><td><p>A100-80GB</p></td>
<td colspan="2"></td>
</tr>
<tr class="row-odd"><td></td>
<td><p>all-balanced</p></td>
<td><p>1g.10gb:2</p>
<p>2g.20gb:1</p>
<p>3g.40gb:1</p>
</td>
</tr>
<tr class="row-even"><td><p>A30-24GB</p></td>
<td colspan="2"></td>
</tr>
<tr class="row-odd"><td></td>
<td><p>all-balanced</p></td>
<td><p>1g.6gb: 2</p>
<p>2g.12gb:1</p>
</td>
</tr>
</tbody>
</table>
</section>
<section id="set-the-mig-advertisement-strategy-and-apply-the-mig-partitioning">
<span id="mig-partitioning"></span><h3>Set the MIG advertisement strategy and apply the MIG partitioning<a class="headerlink" href="#set-the-mig-advertisement-strategy-and-apply-the-mig-partitioning" title="Permalink to this heading"></a></h3>
<p>Having decided on your advertisement strategy you need to set this by editing the default cluster policy and then apply the MIG partitioning profile.</p>
<p>For example to set the advertisement strategy to <code class="docutils literal notranslate"><span class="pre">mixed</span></code> and the MIG partitioning profile to 3x 2g.10gb MIG devices follow the step below:</p>
<ol class="arabic">
<li><p>In the OpenShift Container Platform CLI run the following:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span><span class="nv">STRATEGY</span><span class="o">=</span>mixed<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>oc<span class="w"> </span>patch<span class="w"> </span>clusterpolicy/gpu-cluster-policy<span class="w"> </span>--type<span class="o">=</span><span class="s1">&#39;json&#39;</span><span class="w"> </span>-p<span class="o">=</span><span class="s1">&#39;[{&quot;op&quot;: &quot;replace&quot;, &quot;path&quot;: &quot;/spec/mig/strategy&quot;, &quot;value&quot;: &#39;</span><span class="nv">$STRATEGY</span><span class="s1">&#39;}]&#39;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This may take a while so be patient and wait at least 10-20 minutes before digging deeper into any form of troubleshooting.</p>
</div>
</li>
<li><p>In the OpenShift Container Platform web console, from the side menu, select <strong>Operators</strong> &gt; <strong>Installed Operators</strong>, then click the <strong>NVIDIA GPU Operator</strong>.</p></li>
<li><p>Select the <strong>ClusterPolicy</strong> tab. The status of the newly deployed ClusterPolicy <strong>gpu-cluster-policy</strong> for the <strong>NVIDIA GPU Operator</strong> displays <code class="docutils literal notranslate"><span class="pre">State:ready</span></code> once the installation succeeded.</p>
<img alt="../../_images/cluster_policy_suceed8.png" src="../../_images/cluster_policy_suceed8.png" />
</li>
<li><p>Apply the desired MIG partitioning profile. To configure 3x 2g.10gb MIG devices run the following:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span><span class="nv">MIG_CONFIGURATION</span><span class="o">=</span>all-2g.10gb<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>oc<span class="w"> </span>label<span class="w"> </span>node/<span class="nv">$NODE_NAME</span><span class="w"> </span>nvidia.com/mig.config<span class="o">=</span><span class="nv">$MIG_CONFIGURATION</span><span class="w"> </span>--overwrite
</pre></div>
</div>
</li>
<li><p>Wait for the <code class="docutils literal notranslate"><span class="pre">mig-manager</span></code> to perform the reconfiguration:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>oc<span class="w"> </span>-n<span class="w"> </span>nvidia-gpu-operator<span class="w"> </span>logs<span class="w"> </span>ds/nvidia-mig-manager<span class="w"> </span>--all-containers<span class="w"> </span>-f<span class="w"> </span>--prefix
</pre></div>
</div>
<p>The status of the reconfiguration should change from success → pending → success.</p>
</li>
<li><p>Verify the new configuration is applied:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>oc<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>-n<span class="w"> </span>nvidia-gpu-operator<span class="w"> </span>-lapp<span class="o">=</span>nvidia-driver-daemonset<span class="w"> </span>-owide
</pre></div>
</div>
<p>Select the name of the Pod on the MIG GPU enabled node and run the following:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>oc<span class="w"> </span>rsh<span class="w"> </span>-n<span class="w"> </span>nvidia-gpu-operator<span class="w"> </span><span class="nv">$POD_NAME</span><span class="w"> </span>nvidia-smi<span class="w"> </span>mig<span class="w"> </span>-lgi
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">+----------------------------------------------------+</span>
<span class="go">| GPU instances:                                     |</span>
<span class="go">| GPU   Name          Profile  Instance   Placement  |</span>
<span class="go">|                       ID       ID       Start:Size |</span>
<span class="go">|====================================================|</span>
<span class="go">|   0  MIG 2g.10gb       19        3          4:2    |</span>
<span class="go">+----------------------------------------------------+</span>
<span class="go">|   0  MIG 2g.10gb       19        5          0:2    |</span>
<span class="go">+----------------------------------------------------+</span>
<span class="go">|   0  MIG 2g.10gb       19        6          2:2    |</span>
<span class="go">+----------------------------------------------------+</span>
</pre></div>
</div>
<p>With the profile in step 4 applied the A100 is configured into 3 MIG devices.</p>
</li>
<li><p>Check the node has been labeled:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>oc<span class="w"> </span>get<span class="w"> </span>nodes/<span class="nv">$NODE_NAME</span><span class="w"> </span>--show-labels<span class="w"> </span><span class="p">|</span><span class="w"> </span>tr<span class="w"> </span><span class="s1">&#39;,&#39;</span><span class="w"> </span><span class="s1">&#39;\n&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>nvidia.com
</pre></div>
</div>
<p>with labels:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">nvidia.com/gpu.present=true</span>
<span class="go">nvidia.com/cuda.driver.major=470</span>
<span class="go">nvidia.com/cuda.driver.minor=57</span>
<span class="go">nvidia.com/cuda.driver.rev=02</span>
<span class="go">nvidia.com/cuda.runtime.major=11</span>
<span class="go">nvidia.com/cuda.runtime.minor=4</span>
<span class="go">nvidia.com/gpu.compute.major=8</span>
<span class="go">nvidia.com/gpu.compute.minor=0</span>
<span class="go">nvidia.com/gpu.count=1</span>
<span class="go">nvidia.com/gpu.family=ampere</span>
<span class="go">nvidia.com/gpu.machine=...</span>
<span class="go">nvidia.com/gpu.memory=40536</span>
<span class="go">nvidia.com/gpu.product=NVIDIA-A100-SXM4-40GB</span>
<span class="go">nvidia.com/mig-2g.10gb.count=3</span>
<span class="go">nvidia.com/mig-2g.10gb.engines.copy=2</span>
<span class="go">nvidia.com/mig-2g.10gb.engines.decoder=1</span>
<span class="go">nvidia.com/mig-2g.10gb.engines.encoder=0</span>
<span class="go">nvidia.com/mig-2g.10gb.engines.jpeg=0</span>
<span class="go">nvidia.com/mig-2g.10gb.engines.ofa=0</span>
<span class="go">nvidia.com/mig-2g.10gb.memory=9984</span>
<span class="go">nvidia.com/mig-2g.10gb.multiprocessors=28</span>
<span class="go">nvidia.com/mig-2g.10gb.slices.ci=2</span>
<span class="go">nvidia.com/mig-2g.10gb.slices.gi=2</span>
<span class="go">nvidia.com/mig.config.state=success</span>
<span class="go">nvidia.com/mig.config=all-2g.10gb</span>
<span class="go">nvidia.com/mig.strategy=mixed</span>
<span class="go">[...]</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The extract above shows the strategy is set to <code class="docutils literal notranslate"><span class="pre">mixed</span></code> with the MIG configuration set to <code class="docutils literal notranslate"><span class="pre">all-2g.10gb</span></code>.</p>
</div>
</li>
<li><p>Verify that the MIG instances are exposed:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>oc<span class="w"> </span>get<span class="w"> </span>node/<span class="nv">$NODE_NAME</span><span class="w"> </span>-ojsonpath<span class="o">={</span>.status.allocatable<span class="o">}</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>jq<span class="w"> </span>.<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>nvidia
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">&quot;nvidia.com/mig-2g.10gb&quot;: &quot;3&quot;,</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You can ignore values set to 0.</p>
</div>
</li>
</ol>
</section>
</section>
<section id="creating-and-applying-a-custom-mig-configuration">
<h2>Creating and applying a custom MIG configuration<a class="headerlink" href="#creating-and-applying-a-custom-mig-configuration" title="Permalink to this heading"></a></h2>
<p>Follow the guidance below to create a new slicing profile.</p>
<ol class="arabic">
<li><p>Prepare a custom <code class="docutils literal notranslate"><span class="pre">configmap</span></code> resource file for example <code class="docutils literal notranslate"><span class="pre">custom_configmap.yaml</span></code>. Use the <a class="reference external" href="https://gitlab.com/nvidia/kubernetes/gpu-operator/-/blob/v1.8.0/assets/state-mig-manager/0400_configmap.yaml">configmap</a>  as guidance to help you build that custom configuration. For more documentation about the file format see <a class="reference external" href="https://github.com/NVIDIA/mig-parted">mig-parted</a>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>For a list of all supported combinations and placements of profiles on A100 and A30, refer to the section on <a class="reference external" href="https://docs.nvidia.com/datacenter/tesla/mig-user-guide/index.html#supported-profiles">supported profiles</a>.</p>
</div>
</li>
<li><p>Create the custom configuration within the <code class="docutils literal notranslate"><span class="pre">nvidia-gpu-operator</span></code> namespace:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span><span class="nv">CONFIG_FILE</span><span class="o">=</span>/path/to/custom_configmap.yaml<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>oc<span class="w"> </span>create<span class="w"> </span>configmap<span class="w"> </span>custom-mig-parted-config<span class="w"> </span><span class="se">\</span>
<span class="w">     </span>--from-file<span class="o">=</span>config.yaml<span class="o">=</span><span class="nv">$CONFIG_FILE</span><span class="w"> </span><span class="se">\</span>
<span class="w">     </span>-n<span class="w"> </span>nvidia-gpu-operator
</pre></div>
</div>
</li>
<li><p>Edit the cluster policy and enter the name of the config map in the field <code class="docutils literal notranslate"><span class="pre">spec.migManager.config.name</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>oc<span class="w"> </span>edit<span class="w"> </span>clusterpolicy
<span class="go">  spec:</span>
<span class="go">    migManager:</span>
<span class="go">      config:</span>
<span class="go">        name: custom-mig-parted-config</span>
</pre></div>
</div>
</li>
<li><p>Label the node with this newly created profile following the guidance in <a class="reference internal" href="#mig-partitioning"><span class="std std-ref">Set the MIG advertisement strategy and apply the MIG partitioning</span></a>.</p></li>
</ol>
</section>
<section id="running-a-sample-gpu-application">
<h2>Running a sample GPU application<a class="headerlink" href="#running-a-sample-gpu-application" title="Permalink to this heading"></a></h2>
<p>Let’s run a simple CUDA sample, in this case <code class="docutils literal notranslate"><span class="pre">vectorAdd</span></code> by requesting a GPU resource as you would normally do in Kubernetes.</p>
<p>If the cluster is configured with the <code class="docutils literal notranslate"><span class="pre">mixed</span></code> advertisement strategy.</p>
<ol class="arabic">
<li><p>Request the MIG instance with <code class="docutils literal notranslate"><span class="pre">nvidia.com/mig-2g.10gb:</span> <span class="pre">1</span></code> as follows:</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>There is no need for a nodeSelector, as the Pod is necessarily scheduled on a <code class="docutils literal notranslate"><span class="pre">2g.10gb</span></code> MIG instance.</p>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>cat<span class="w"> </span>&lt;&lt;<span class="w"> </span>EOF<span class="w"> </span><span class="p">|</span><span class="w"> </span>oc<span class="w"> </span>create<span class="w"> </span>-f<span class="w"> </span>-

<span class="go">apiVersion: v1</span>
<span class="go">kind: Pod</span>
<span class="go">metadata:</span>
<span class="go">  name: cuda-vectoradd</span>
<span class="go">spec:</span>
<span class="go">  restartPolicy: OnFailure</span>
<span class="go">  containers:</span>
<span class="go">  - name: cuda-vectoradd</span>
<span class="go">    image: &quot;nvidia/samples:vectoradd-cuda11.2.1&quot;</span>
<span class="go">    resources:</span>
<span class="go">      limits:</span>
<span class="go">        nvidia.com/mig-2g.10gb: 1</span>
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">pod/cuda-vectoradd created</span>
</pre></div>
</div>
</li>
<li><p>Check the logs of the container:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>oc<span class="w"> </span>logs<span class="w"> </span>cuda-vectoradd
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">[Vector addition of 50000 elements]</span>
<span class="go">Copy input data from the host memory to the CUDA device</span>
<span class="go">CUDA kernel launch with 196 blocks of 256 threads</span>
<span class="go">Copy output data from the CUDA device to the host memory</span>
<span class="go">Test PASSED</span>
<span class="go">Done</span>
</pre></div>
</div>
</li>
</ol>
<p>If the cluster is configured with the <code class="docutils literal notranslate"><span class="pre">single</span></code> advertisement strategy.</p>
<ol class="arabic">
<li><p>Request the MIG instance with <code class="docutils literal notranslate"><span class="pre">nvidia.com/gpu:</span> <span class="pre">1</span></code> and enforce the Pod scheduling on a node with a <code class="docutils literal notranslate"><span class="pre">2g.10gb</span></code> MIG instance with the <code class="docutils literal notranslate"><span class="pre">nodeSelector</span></code> stanza as follows:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>cat<span class="w"> </span>&lt;&lt;<span class="w"> </span>EOF<span class="w"> </span><span class="p">|</span><span class="w"> </span>oc<span class="w"> </span>create<span class="w"> </span>-f<span class="w"> </span>-

<span class="go">apiVersion: v1</span>
<span class="go">kind: Pod</span>
<span class="go">metadata:</span>
<span class="go">  name: cuda-vectoradd</span>
<span class="go">spec:</span>
<span class="go">  restartPolicy: OnFailure</span>
<span class="go">  containers:</span>
<span class="go">  - name: cuda-vectoradd</span>
<span class="go">    image: &quot;nvidia/samples:vectoradd-cuda11.2.1&quot;</span>
<span class="go">    resources:</span>
<span class="go">      limits:</span>
<span class="go">        nvidia.com/gpu: 1</span>
<span class="go">  nodeSelector:</span>
<span class="go">    nvidia.com/gpu.product: A100-SXM4-40GB-MIG-1g.5gb</span>
<span class="go">EOF</span>
</pre></div>
</div>
</li>
</ol>
</section>
<section id="disable-the-mig-mode">
<h2>Disable the MIG mode<a class="headerlink" href="#disable-the-mig-mode" title="Permalink to this heading"></a></h2>
<p>To turn MIG mode off so that you can utilize the full capacity of the GPU run the following:</p>
<blockquote>
<div><div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span><span class="nv">MIG_CONFIGURATION</span><span class="o">=</span>all-disabled<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>oc<span class="w"> </span>label<span class="w"> </span>node/<span class="nv">$NODE_NAME</span><span class="w"> </span>nvidia.com/mig.config<span class="o">=</span><span class="nv">$MIG_CONFIGURATION</span><span class="w"> </span>--overwrite
</pre></div>
</div>
</div></blockquote>
</section>
<section id="troubleshooting">
<h2>Troubleshooting<a class="headerlink" href="#troubleshooting" title="Permalink to this heading"></a></h2>
<p>The MIG reconfiguration is handled exclusively by the controller deployed within the <code class="docutils literal notranslate"><span class="pre">nvidia-mig-manager</span></code> DaemonSet. Inspecting the logs of these Pods should give a clue about what went wrong.</p>
<ol class="arabic">
<li><p>Check the logs of the container:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>oc<span class="w"> </span>logs<span class="w"> </span>nvidia-mig-manager
</pre></div>
</div>
<p>The cluster administrator is expected to drain the node from any GPU workload, before requesting the MIG reconfiguration. If the node is not properly drained, the <code class="docutils literal notranslate"><span class="pre">nvidia-mig-manager</span></code> will fail with this error in the logs:</p>
<blockquote>
<div><div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go"> Updating MIG config: map[2g.10gb:3]</span>
<span class="go">Error clearing MigConfig: error destroying Compute instance for profile &#39;(0, 0)&#39;: In use by another client</span>
<span class="go">Error clearing MIG config on GPU 0, erroneous devices may persist</span>
<span class="go">Error setting MIGConfig: error attempting multiple config orderings: all orderings failed</span>
<span class="go">Restarting all GPU clients previously shutdown by reenabling their component-specific nodeSelector labels</span>
<span class="go">Changing the &#39;nvidia.com/mig.config.state&#39; node label to &#39;failed&#39;</span>
</pre></div>
</div>
</div></blockquote>
</li>
</ol>
<p>Resolve this issue by:</p>
<ol class="arabic">
<li><p>Correctly draining the node. For guidance on draining a node see, the OpenShift Container Platform documentation <a class="reference external" href="https://docs.openshift.com/container-platform/latest/nodes/nodes/nodes-nodes-working.html#nodes-nodes-working-evacuating_nodes-nodes-working">Understanding how to evacuate pods on nodes</a>.</p></li>
<li><p>Retrigger the reconfiguration by forcing the label update:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>oc<span class="w"> </span>label<span class="w"> </span>node/<span class="nv">$NODE_NAME</span><span class="w"> </span>nvidia.com/mig.config-<span class="w"> </span>--overwrite
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>oc<span class="w"> </span>label<span class="w"> </span>node/<span class="nv">$NODE_NAME</span><span class="w"> </span>nvidia.com/mig.config<span class="o">=</span><span class="nv">$MIG_CONFIGURATION</span><span class="w"> </span>--overwrite
</pre></div>
</div>
</li>
</ol>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="nvaie-with-ocp.html" class="btn btn-neutral float-left" title="NVIDIA AI Enterprise with OpenShift" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="clean-up.html" class="btn btn-neutral float-right" title="Cleanup" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2018-2023, NVIDIA Corporation.
      <span class="lastupdated">Last updated on 2023-03-09.
      </span></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>  

  <style>
  a:link, a:visited {
    color: #76b900;
  }

  a:hover {
    color: #8c0;
  }

  .rst-content dl:not(.docutils) dt {
    background: rgba(118, 185, 0, 0.1);
    color: rgba(59,93,0,1);
    border-top: solid 3px rgba(59,93,0,1);
  }
  </style>
  

</body>
</html>