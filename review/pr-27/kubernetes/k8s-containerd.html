<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Install Kubernetes &mdash; NVIDIA Cloud Native Technologies  documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/copybutton.css" type="text/css" />
      <link rel="stylesheet" href="../_static/tabs.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/custom.css" type="text/css" />
    <link rel="shortcut icon" href="../_static/nvidia.ico"/>
    <link rel="canonical" href="https://docs.nvidia.com/datacenter/cloud-native/kubernetes/k8s-containerd.html"/>
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
        <script src="../_static/clipboard.min.js"></script>
        <script src="../_static/copybutton.js"></script>
        <script src="../_static/js/google-analytics/google-analytics-tracker.js"></script>
        <script src="../_static/js/google-analytics/google-analytics-write.js"></script>
        <script src="//assets.adobedtm.com/b92787824f2e0e9b68dc2e993f9bd995339fe417/satelliteLib-7ba51e58dc61bcb0e9311aadd02a0108ab24cc6c.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" > 
            <a href="../contents.html">
            <img src="../_static/NVLogo_H_B&W.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

  <style>
    /* Sidebar header (and topbar for mobile) */
    .wy-side-nav-search, .wy-nav-top {
      background: #76b900;
    }

    .wy-side-nav-search a:link, .wy-nav-top a:link {
      color: #fff;
    }
    .wy-side-nav-search a:visited, .wy-nav-top a:visited {
      color: #fff;
    }
    .wy-side-nav-search a:hover, .wy-nav-top a:hover {
      color: #fff;
    }

    .wy-menu-vertical a:link, .wy-menu-vertical a:visited {
      color: #d9d9d9
    }

    .wy-menu-vertical a:active {
      background-color: #76b900
    }

    .wy-side-nav-search>div.version {
      color: rgba(0, 0, 0, 0.3)
    }

    .wy-nav-content {
      max-width: 1000px;
    }
  </style>
  
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">NVIDIA Container Toolkit:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../container-toolkit/overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../container-toolkit/concepts.html">Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../container-toolkit/arch-overview.html">Architecture Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../container-toolkit/install-guide.html">Installation Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../container-toolkit/troubleshooting.html">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../container-toolkit/user-guide.html">User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../container-toolkit/release-notes.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../container-toolkit/archive.html">Archive</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">NVIDIA GPU Operator:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../gpu-operator/overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gpu-operator/getting-started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gpu-operator/platform-support.html">Platform Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gpu-operator/release-notes.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gpu-operator/gpu-driver-upgrades.html">GPU Driver Upgrades</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gpu-operator/install-gpu-operator-vgpu.html">NVIDIA vGPU</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gpu-operator/install-gpu-operator-nvaie.html">NVIDIA AI Enterprise</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gpu-operator/openshift/contents.html">GPU Operator on OpenShift</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gpu-operator/gpu-operator-mig.html">GPU Operator with MIG</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gpu-operator/gpu-sharing.html">Time-Slicing GPUs in Kubernetes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gpu-operator/gpu-operator-rdma.html">GPUDirect RDMA and GPUDirect Storage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gpu-operator/gpu-operator-kubevirt.html">GPU Operator with KubeVirt</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gpu-operator/appendix.html">Advanced Configurations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gpu-operator/archive.html">Archive</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Kubernetes with GPUs:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="install-k8s.html">Install Kubernetes</a></li>
<li class="toctree-l1"><a class="reference internal" href="mig-k8s.html">MIG Support in Kubernetes</a></li>
<li class="toctree-l1"><a class="reference internal" href="anthos-guide.html">NVIDIA GPUs with Google Cloud’s Anthos</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">NVIDIA GPUs and Red Hat Device Edge</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../edge/nvidia-gpu-with-device-edge.html">Accelerating workloads with NVIDIA GPUs with Red Hat Device Edge</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">GPU Telemetry:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../gpu-telemetry/dcgm-exporter.html">DCGM-Exporter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gpu-telemetry/dcgm-exporter.html#integrating-gpu-telemetry-into-kubernetes">Integrating GPU Telemetry into Kubernetes</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Multi-Instance GPU:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../mig/mig.html">Multi-Instance GPU</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mig/mig-k8s.html">MIG Support in Kubernetes</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Driver Containers:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../driver-containers/overview.html">Overview</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Playground:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../playground/dind.html">Docker-in-Docker</a></li>
<li class="toctree-l1"><a class="reference internal" href="../playground/x-arch.html">Running Cross-Architecture Containers</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../contents.html">NVIDIA Cloud Native Technologies</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../contents.html" class="icon icon-home"></a> &raquo;</li>
      <li>Install Kubernetes</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="install-kubernetes">
<span id="k8s-containerd"></span><h1>Install Kubernetes<a class="headerlink" href="#install-kubernetes" title="Permalink to this heading"></a></h1>
<p>Download release tarball
Release=1.4.6
release-os-arch.tar.gz
the cri-containerd-cni includes the systemd service file, shims, crictl tools etc. compared to the containerd tarball</p>
<ol class="arabic simple">
<li><p>curl -fOsSL <a class="reference external" href="https://github.com/containerd/containerd/releases/download/v1.4.3/cri-containerd-cni-1.4.3-linux-amd64.tar.gz">https://github.com/containerd/containerd/releases/download/v1.4.3/cri-containerd-cni-1.4.3-linux-amd64.tar.gz</a></p></li>
</ol>
<p>Install containerd
#. sudo tar –no-overwrite-dir -C / -xzf cri-containerd-${VERSION}.linux-amd64.tar.gz
#. sudo systemctl start containerd</p>
<p>Disable swap
sudo swapoff -a
Let iptables see bridged traffic</p>
<blockquote>
<div><p>sudo modprobe br_netfilter
cat &lt;&lt;EOF | sudo tee /etc/sysctl.d/k8s.conf
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
net.ipv4.ip_forward                = 1
EOF
sudo sysctl –system</p>
</div></blockquote>
<dl class="simple">
<dt>Install pre-requisities for containerd</dt><dd><p>Install containerd
Configure systemd
Manually configure cgroup driver for kubelet
<a class="reference external" href="https://kubernetes.io/docs/setup/production-environment/container-runtimes/#containerd">https://kubernetes.io/docs/setup/production-environment/container-runtimes/#containerd</a></p>
</dd>
</dl>
<p>Install kublet, kubectl and kubeadm
Create Systemd Drop-In for Containerd
sudo vim /etc/systemd/system/kubelet.service.d/0-containerd.conf
[Service]
Environment=”KUBELET_EXTRA_ARGS=–container-runtime=remote –runtime-request-timeout=15m –container-runtime-endpoint=unix:///run/containerd/containerd.sock –cgroup-driver=’systemd’”
systemctl daemon-reload
systemctl restart kubelet</p>
<p>install nvidia-container-runtime</p>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading"></a></h2>
<p>Kubernetes is an open-source platform for automating deployment, scaling and managing containerized applications. Kubernetes includes support
for GPUs and enhancements to Kubernetes so users can easily configure and use GPU resources for accelerating workloads such as deep learning.
This document describes two methods for installing upstream Kubernetes with NVIDIA supported components, such as drivers, plugins and runtime -
a method using <a class="reference external" href="https://github.com/NVIDIA/deepops">DeepOps</a> and a method using <a class="reference external" href="https://kubernetes.io/docs/reference/setup-tools/kubeadm/">Kubeadm</a>.</p>
<p>To set up orchestration and scheduling in your cluster, it is highly recommended that you use DeepOps. DeepOps is a modular collection of ansible scripts
which automate the deployment of Kubernetes, Slurm, or a hybrid combination of the two across your nodes. It also installs the necessary GPU drivers,
NVIDIA Container Toolkit for Docker (<code class="docutils literal notranslate"><span class="pre">nvidia-docker2</span></code>), and various other dependencies for GPU-accelerated work. Encapsulating best practices for NVIDIA GPUs,
it can be customized or run as individual components, as needed.</p>
<p>With <code class="docutils literal notranslate"><span class="pre">kubeadm</span></code>, this document will walk through the steps for installing a single node Kubernetes cluster (where we untaint the control plane
so it can run GPU pods), but the cluster can be scaled easily with additional nodes.</p>
</section>
<section id="installing-kubernetes-using-deepops">
<h2>Installing Kubernetes Using DeepOps<a class="headerlink" href="#installing-kubernetes-using-deepops" title="Permalink to this heading"></a></h2>
<p>Use DeepOps to automate deployment, especially for a cluster of many worker nodes. Use the following procedure to install Kubernetes using DeepOps:</p>
<ol class="arabic">
<li><p>Pick a provisioning node to deploy from.
This is where the DeepOps Ansible scripts run from and is often a development laptop that has a connection to the target cluster. On this provisioning node,
clone the DeepOps repository with the following command:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/NVIDIA/deepops.git
</pre></div>
</div>
</li>
<li><p>Optionally, check out a recent release tag with the following command:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span><span class="nb">cd</span><span class="w"> </span>deepops<span class="w"> </span><span class="se">\</span>
<span class="w">   </span><span class="o">&amp;&amp;</span><span class="w"> </span>git<span class="w"> </span>checkout<span class="w"> </span>tags/20.10
</pre></div>
</div>
<p>If you do not explicitly use a release tag, then the latest development code is used, and not an official release.</p>
</li>
<li><p>Follow the instructions in the <a class="reference external" href="https://github.com/NVIDIA/deepops/blob/master/docs/kubernetes-cluster.md">DeepOps Kubernetes Deployment Guide</a> to install Kubernetes.</p></li>
</ol>
</section>
<section id="installing-kubernetes-using-kubeadm">
<h2>Installing Kubernetes Using Kubeadm<a class="headerlink" href="#installing-kubernetes-using-kubeadm" title="Permalink to this heading"></a></h2>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The method described in this section is an alternative to using DeepOps. If you have deployed using DeepOps, then skip this section.</p>
</div>
<p>For a less scripted approach, especially for smaller clusters or where there is a desire to learn the components that make up a Kubernetes cluster, use Kubeadm.</p>
<p>A Kubernetes cluster is composed of master nodes and worker nodes. The master nodes run the control plane components of Kubernetes which allows your
cluster to function properly. These components include the API Server (front-end to the <code class="docutils literal notranslate"><span class="pre">kubectl</span></code> CLI), <strong>etcd</strong> (stores the cluster state) and others.</p>
<p>Use CPU-only (GPU-free) master nodes, which run the control plane components: Scheduler, API-server, and Controller Manager. Control plane components can
have some impact on your CPU intensive tasks and conversely, CPU or HDD/SSD intensive components can have an impact on your control plane components.</p>
<section id="before-you-begin">
<h3>Before You Begin<a class="headerlink" href="#before-you-begin" title="Permalink to this heading"></a></h3>
<p>Before proceeding to install the components, check that all Kubernetes <a class="reference external" href="https://kubernetes.io/docs/setup/independent/install-kubeadm/#before-you-begin">prerequisites</a>
have been satisfied. These prerequisites include:</p>
<ul class="simple">
<li><p>Check network adapters and required ports</p></li>
<li><p>Disable swap on the nodes so that kubelet can work correctly</p></li>
<li><p>Install a supported container runtime such as Docker, containerd or CRI-O</p></li>
</ul>
<p>Depending on your Linux distribution, refer to the steps below:</p>
<ul class="simple">
<li><p><a class="reference internal" href="#ubuntu-k8s"><span class="std std-ref">Ubuntu LTS</span></a></p></li>
<li><p><a class="reference internal" href="#centos-k8s"><span class="std std-ref">CentOS</span></a></p></li>
</ul>
</section>
<section id="ubuntu-lts">
<span id="ubuntu-k8s"></span><h3>Ubuntu LTS<a class="headerlink" href="#ubuntu-lts" title="Permalink to this heading"></a></h3>
<p>This section provides steps for setting up K8s on Ubuntu 18.04 and 20.04 LTS distributions.</p>
<section id="install-docker">
<h4>Install Docker<a class="headerlink" href="#install-docker" title="Permalink to this heading"></a></h4>
<p>Follow the steps in this <a class="reference external" href="https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/install-guide.html#installing-on-ubuntu-and-debian">guide</a> to install Docker on Ubuntu.</p>
</section>
<section id="install-kubernetes-components">
<h4>Install Kubernetes components<a class="headerlink" href="#install-kubernetes-components" title="Permalink to this heading"></a></h4>
<p>First, install some dependencies:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>sudo<span class="w"> </span>apt-get<span class="w"> </span>update<span class="w"> </span><span class="se">\</span>
<span class="w">   </span><span class="o">&amp;&amp;</span><span class="w"> </span>sudo<span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>apt-transport-https<span class="w"> </span>curl
</pre></div>
</div>
<p>Add the package repository keys:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>curl<span class="w"> </span>-s<span class="w"> </span>https://packages.cloud.google.com/apt/doc/apt-key.gpg<span class="w"> </span><span class="p">|</span><span class="w"> </span>sudo<span class="w"> </span>apt-key<span class="w"> </span>add<span class="w"> </span>-
</pre></div>
</div>
<p>And the repository:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>cat<span class="w"> </span>&lt;&lt;EOF<span class="w"> </span><span class="p">|</span><span class="w"> </span>sudo<span class="w"> </span>tee<span class="w"> </span>/etc/apt/sources.list.d/kubernetes.list
<span class="go">deb https://apt.kubernetes.io/ kubernetes-xenial main</span>
<span class="go">EOF</span>
</pre></div>
</div>
<p>Update the package listing and install the required packages, and <code class="docutils literal notranslate"><span class="pre">init</span></code> using <code class="docutils literal notranslate"><span class="pre">kubeadm</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>sudo<span class="w"> </span>apt-get<span class="w"> </span>update<span class="w"> </span><span class="se">\</span>
<span class="w">   </span><span class="o">&amp;&amp;</span><span class="w"> </span>sudo<span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>-q<span class="w"> </span>kubelet<span class="w"> </span>kubectl<span class="w"> </span>kubeadm<span class="w"> </span><span class="se">\</span>
<span class="w">   </span><span class="o">&amp;&amp;</span><span class="w"> </span>sudo<span class="w"> </span>kubeadm<span class="w"> </span>init<span class="w"> </span>--pod-network-cidr<span class="o">=</span><span class="m">192</span>.168.0.0/16
</pre></div>
</div>
<p>Finish the configuration setup with Kubeadm:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>mkdir<span class="w"> </span>-p<span class="w"> </span><span class="nv">$HOME</span>/.kube<span class="w"> </span><span class="se">\</span>
<span class="w">   </span><span class="o">&amp;&amp;</span><span class="w"> </span>sudo<span class="w"> </span>cp<span class="w"> </span>-i<span class="w"> </span>/etc/kubernetes/admin.conf<span class="w"> </span><span class="nv">$HOME</span>/.kube/config<span class="w"> </span><span class="se">\</span>
<span class="w">   </span><span class="o">&amp;&amp;</span><span class="w"> </span>sudo<span class="w"> </span>chown<span class="w"> </span><span class="k">$(</span>id<span class="w"> </span>-u<span class="k">)</span>:<span class="k">$(</span>id<span class="w"> </span>-g<span class="k">)</span><span class="w"> </span><span class="nv">$HOME</span>/.kube/config
</pre></div>
</div>
</section>
<section id="configure-networking">
<h4>Configure networking<a class="headerlink" href="#configure-networking" title="Permalink to this heading"></a></h4>
<p>Now, setup networking with Calico:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>https://docs.projectcalico.org/manifests/calico.yaml
</pre></div>
</div>
<p>Untaint the control plane, so it can be used to schedule GPU pods in our simplistic single-node cluster:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>kubectl<span class="w"> </span>taint<span class="w"> </span>nodes<span class="w"> </span>--all<span class="w"> </span>node-role.kubernetes.io/master-
</pre></div>
</div>
<p>Your cluster should now be ready to schedule containerized applications.</p>
</section>
</section>
<section id="centos">
<span id="centos-k8s"></span><h3>CentOS<a class="headerlink" href="#centos" title="Permalink to this heading"></a></h3>
<p>Follow the steps in this section for setting up K8s on CentOS 7/8.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you’re using CentOS 7/8 on a cloud IaaS platform such as EC2, then you may need to do some additional setup as listed here:</p>
<ol class="arabic">
<li><p>Choose an official CentOS image for your EC2 region: <a class="reference external" href="https://wiki.centos.org/Cloud/AWS">https://wiki.centos.org/Cloud/AWS</a></p></li>
<li><p>Install some of the prerequisites:</p>
<p>On CentOS 8:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>sudo<span class="w"> </span>dnf<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>tar<span class="w"> </span>bzip2<span class="w"> </span>make<span class="w"> </span>automake<span class="w"> </span>gcc<span class="w"> </span>gcc-c++<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>pciutils<span class="w"> </span>elfutils-libelf-devel<span class="w"> </span>libglvnd-devel<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>iptables<span class="w"> </span>firewalld<span class="w"> </span>bind-utils<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>vim<span class="w"> </span>wget
</pre></div>
</div>
<p>On CentOS 7:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>sudo<span class="w"> </span>yum<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>tar<span class="w"> </span>bzip2<span class="w"> </span>make<span class="w"> </span>automake<span class="w"> </span>gcc<span class="w"> </span>gcc-c++<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>pciutils<span class="w"> </span>elfutils-libelf-devel<span class="w"> </span>libglvnd-devel<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>iptables<span class="w"> </span>firewalld<span class="w"> </span>bind-utils<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>vim<span class="w"> </span>wget
</pre></div>
</div>
</li>
<li><p>Update the running kernel to ensure you’re running the latest updates</p>
<p>On CentOS 8:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>sudo<span class="w"> </span>dnf<span class="w"> </span>update<span class="w"> </span>-y
</pre></div>
</div>
<p>On CentOS 7:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>sudo<span class="w"> </span>yum<span class="w"> </span>update<span class="w"> </span>-y
</pre></div>
</div>
</li>
<li><p>Reboot your VM</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>sudo<span class="w"> </span>reboot
</pre></div>
</div>
</li>
</ol>
</div>
<section id="disable-nouveau">
<h4>Disable Nouveau<a class="headerlink" href="#disable-nouveau" title="Permalink to this heading"></a></h4>
<p>For a successful install of the NVIDIA driver, the Nouveau drivers must first be disabled.</p>
<p>Create a file at <code class="docutils literal notranslate"><span class="pre">/etc/modprobe.d/blacklist-nouveau.conf</span></code> with the following contents:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">blacklist nouveau</span>
<span class="go">options nouveau modeset=0</span>
</pre></div>
</div>
<p>Regenerate the kernel initramfs:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>sudo<span class="w"> </span>dracut<span class="w"> </span>--force
</pre></div>
</div>
<p>Reboot the system before proceeding with the rest of this guide.</p>
</section>
<section id="id1">
<h4>Install Docker<a class="headerlink" href="#id1" title="Permalink to this heading"></a></h4>
<p>Follow the steps in this <a class="reference external" href="https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/install-guide.html#setting-up-docker-on-centos-7-8">guide</a> to install Docker on CentOS 7/8.</p>
</section>
<section id="configuring-the-system">
<h4>Configuring the system<a class="headerlink" href="#configuring-the-system" title="Permalink to this heading"></a></h4>
<p>For the remaining part of this section, we will follow the general steps for using <a class="reference external" href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/">kubeadm</a>.
Also, for convenience, let’s enter into an interactive <code class="docutils literal notranslate"><span class="pre">sudo</span></code> session since most of the remaining commands require root privileges:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>sudo<span class="w"> </span>-i
</pre></div>
</div>
<section id="disabling-selinux">
<h5>Disabling SELinux<a class="headerlink" href="#disabling-selinux" title="Permalink to this heading"></a></h5>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>setenforce<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="se">\</span>
<span class="w">   </span><span class="o">&amp;&amp;</span><span class="w"> </span>sed<span class="w"> </span>-i<span class="w"> </span>--follow-symlinks<span class="w"> </span><span class="s1">&#39;s/SELINUX=enforcing/SELINUX=disabled/g&#39;</span><span class="w"> </span>/etc/sysconfig/selinux
</pre></div>
</div>
</section>
<section id="bridged-traffic-and-iptables">
<h5>Bridged traffic and iptables<a class="headerlink" href="#bridged-traffic-and-iptables" title="Permalink to this heading"></a></h5>
<p>As mentioned in the <code class="docutils literal notranslate"><span class="pre">kubedadm</span></code> documentation, ensure that the <code class="docutils literal notranslate"><span class="pre">br_netfilter</span></code> module is loaded:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>modprobe<span class="w"> </span>br_netfilter
</pre></div>
</div>
<p>Ensure <code class="docutils literal notranslate"><span class="pre">net.bridge.bridge-nf-call-iptables</span></code> is configured correctly:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>cat<span class="w"> </span>&lt;&lt;EOF<span class="w"> </span>&gt;<span class="w"> </span>/etc/sysctl.d/k8s.conf
<span class="go">net.bridge.bridge-nf-call-ip6tables = 1</span>
<span class="go">net.bridge.bridge-nf-call-iptables = 1</span>
<span class="go">EOF</span>
</pre></div>
</div>
<p>and restart the <code class="docutils literal notranslate"><span class="pre">sysctl</span></code> config:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>sysctl<span class="w"> </span>--system
</pre></div>
</div>
</section>
<section id="firewall-and-required-ports">
<h5>Firewall and required ports<a class="headerlink" href="#firewall-and-required-ports" title="Permalink to this heading"></a></h5>
<p>The network plugin requires certain ports to be open on the control plane and worker nodes. See this
<a class="reference external" href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/#check-required-ports">table</a> for more information on
the purpose of these port numbers.</p>
<p>Ensure that <code class="docutils literal notranslate"><span class="pre">firewalld</span></code> is running:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>systemctl<span class="w"> </span>status<span class="w"> </span>firewalld
</pre></div>
</div>
<p>and if required, start <code class="docutils literal notranslate"><span class="pre">firewalld</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>systemctl<span class="w"> </span>--now<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>firewalld
</pre></div>
</div>
<p>Now open the ports:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>firewall-cmd<span class="w"> </span>--permanent<span class="w"> </span>--add-port<span class="o">=</span><span class="m">6443</span>/tcp<span class="w"> </span><span class="se">\</span>
<span class="w">   </span><span class="o">&amp;&amp;</span><span class="w"> </span>firewall-cmd<span class="w"> </span>--permanent<span class="w"> </span>--add-port<span class="o">=</span><span class="m">2379</span>-2380/tcp<span class="w"> </span><span class="se">\</span>
<span class="w">   </span><span class="o">&amp;&amp;</span><span class="w"> </span>firewall-cmd<span class="w"> </span>--permanent<span class="w"> </span>--add-port<span class="o">=</span><span class="m">10250</span>/tcp<span class="w"> </span><span class="se">\</span>
<span class="w">   </span><span class="o">&amp;&amp;</span><span class="w"> </span>firewall-cmd<span class="w"> </span>--permanent<span class="w"> </span>--add-port<span class="o">=</span><span class="m">10251</span>/tcp<span class="w"> </span><span class="se">\</span>
<span class="w">   </span><span class="o">&amp;&amp;</span><span class="w"> </span>firewall-cmd<span class="w"> </span>--permanent<span class="w"> </span>--add-port<span class="o">=</span><span class="m">10252</span>/tcp<span class="w"> </span><span class="se">\</span>
<span class="w">   </span><span class="o">&amp;&amp;</span><span class="w"> </span>firewall-cmd<span class="w"> </span>--permanent<span class="w"> </span>--add-port<span class="o">=</span><span class="m">10255</span>/tcp
</pre></div>
</div>
<p>Its also required to add the <code class="docutils literal notranslate"><span class="pre">docker0</span></code> interface to the public zone and allow for <code class="docutils literal notranslate"><span class="pre">docker0</span></code> ingress and egress:</p>
<p>On CentOS 8:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>nmcli<span class="w"> </span>connection<span class="w"> </span>modify<span class="w"> </span>docker0<span class="w"> </span>connection.zone<span class="w"> </span>public<span class="w"> </span><span class="se">\</span>
<span class="w">   </span><span class="o">&amp;&amp;</span><span class="w"> </span>firewall-cmd<span class="w"> </span>--zone<span class="o">=</span>public<span class="w"> </span>--add-masquerade<span class="w"> </span>--permanent<span class="w"> </span><span class="se">\</span>
<span class="w">   </span><span class="o">&amp;&amp;</span><span class="w"> </span>firewall-cmd<span class="w"> </span>--zone<span class="o">=</span>public<span class="w"> </span>--add-port<span class="o">=</span><span class="m">443</span>/tcp
</pre></div>
</div>
<p>On CentOS 7:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>firewall-cmd<span class="w"> </span>--zone<span class="o">=</span>public<span class="w"> </span>--add-masquerade<span class="w"> </span>--permanent<span class="w"> </span><span class="se">\</span>
<span class="w">   </span><span class="o">&amp;&amp;</span><span class="w"> </span>firewall-cmd<span class="w"> </span>--zone<span class="o">=</span>public<span class="w"> </span>--add-port<span class="o">=</span><span class="m">443</span>/tcp
</pre></div>
</div>
<p>Reload the <code class="docutils literal notranslate"><span class="pre">firewalld</span></code> configuration and <code class="docutils literal notranslate"><span class="pre">dockerd</span></code> for the settings to take effect:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>firewall-cmd<span class="w"> </span>--reload<span class="w"> </span><span class="se">\</span>
<span class="w">   </span><span class="o">&amp;&amp;</span><span class="w"> </span>systemctl<span class="w"> </span>restart<span class="w"> </span>docker
</pre></div>
</div>
<p>Optionally, before we install the Kubernetes control plane, test your container networking using a simple <code class="docutils literal notranslate"><span class="pre">ping</span></code> command:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>docker<span class="w"> </span>run<span class="w"> </span>busybox<span class="w"> </span>ping<span class="w"> </span>google.com
</pre></div>
</div>
</section>
<section id="disable-swap">
<h5>Disable swap<a class="headerlink" href="#disable-swap" title="Permalink to this heading"></a></h5>
<p>For performance, disable swap on your system:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>swapoff<span class="w"> </span>-a
</pre></div>
</div>
</section>
</section>
<section id="id4">
<h4>Install Kubernetes components<a class="headerlink" href="#id4" title="Permalink to this heading"></a></h4>
<p>Add the network repository listing to the package manager configuration:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>cat<span class="w"> </span>&lt;&lt;EOF<span class="w"> </span>&gt;<span class="w"> </span>/etc/yum.repos.d/kubernetes.repo
<span class="go">[kubernetes]</span>
<span class="go">name=Kubernetes</span>
<span class="go">baseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-x86_64</span>
<span class="go">enabled=1</span>
<span class="go">gpgcheck=1</span>
<span class="go">repo_gpgcheck=1</span>
<span class="go">gpgkey=https://packages.cloud.google.com/yum/doc/yum-key.gpg https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg</span>
<span class="go">EOF</span>
</pre></div>
</div>
<p>Install the components:</p>
<p>On CentOS 8:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>dnf<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>kubelet<span class="w"> </span>kubectl<span class="w"> </span>kubeadm
</pre></div>
</div>
<p>On CentOS 7:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>yum<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>kubelet<span class="w"> </span>kubectl<span class="w"> </span>kubeadm
</pre></div>
</div>
<p>Ensure that <code class="docutils literal notranslate"><span class="pre">kubelet</span></code> is started across system reboots:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>systemctl<span class="w"> </span>--now<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>kubelet
</pre></div>
</div>
<p>Now use <code class="docutils literal notranslate"><span class="pre">kubeadm</span></code> to initialize the control plane:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>kubeadm<span class="w"> </span>init<span class="w"> </span>--pod-network-cidr<span class="o">=</span><span class="m">192</span>.168.0.0/16
</pre></div>
</div>
<p>At this point, feel free to exit from the interactive <code class="docutils literal notranslate"><span class="pre">sudo</span></code> session that we started with.</p>
<section id="configure-directories">
<h5>Configure directories<a class="headerlink" href="#configure-directories" title="Permalink to this heading"></a></h5>
<p>To start using the cluster, run the following as a regular user:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>mkdir<span class="w"> </span>-p<span class="w"> </span><span class="nv">$HOME</span>/.kube<span class="w"> </span><span class="se">\</span>
<span class="w">   </span><span class="o">&amp;&amp;</span><span class="w"> </span>sudo<span class="w"> </span>cp<span class="w"> </span>-i<span class="w"> </span>/etc/kubernetes/admin.conf<span class="w"> </span><span class="nv">$HOME</span>/.kube/config<span class="w"> </span><span class="se">\</span>
<span class="w">   </span><span class="o">&amp;&amp;</span><span class="w"> </span>sudo<span class="w"> </span>chown<span class="w"> </span><span class="k">$(</span>id<span class="w"> </span>-u<span class="k">)</span>:<span class="k">$(</span>id<span class="w"> </span>-g<span class="k">)</span><span class="w"> </span><span class="nv">$HOME</span>/.kube/config
</pre></div>
</div>
<p>If you’re using a simplistic cluster (or just testing), you can untaint the control plane node so that it can also run containers:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>kubectl<span class="w"> </span>taint<span class="w"> </span>nodes<span class="w"> </span>--all<span class="w"> </span>node-role.kubernetes.io/master-
</pre></div>
</div>
<p>At this point, your cluster would look like below:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>kubectl<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>-A
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">NAMESPACE     NAME                                                    READY   STATUS    RESTARTS   AGE</span>
<span class="go">kube-system   coredns-f9fd979d6-46hmf                                 0/1     Pending   0          23s</span>
<span class="go">kube-system   coredns-f9fd979d6-v7v4d                                 0/1     Pending   0          23s</span>
<span class="go">kube-system   etcd-ip-172-31-54-109.ec2.internal                      0/1     Running   0          38s</span>
<span class="go">kube-system   kube-apiserver-ip-172-31-54-109.ec2.internal            1/1     Running   0          38s</span>
<span class="go">kube-system   kube-controller-manager-ip-172-31-54-109.ec2.internal   0/1     Running   0          37s</span>
<span class="go">kube-system   kube-proxy-xd5zg                                        1/1     Running   0          23s</span>
<span class="go">kube-system   kube-scheduler-ip-172-31-54-109.ec2.internal            0/1     Running   0          37s</span>
</pre></div>
</div>
</section>
<section id="id5">
<h5>Configure networking<a class="headerlink" href="#id5" title="Permalink to this heading"></a></h5>
<p>For the purposes of this document, we will use Calico as a network plugin to configure networking in our Kubernetes cluster. Due to an
<a class="reference external" href="https://github.com/projectcalico/calico/issues/2322">issue</a> with Calico and iptables on CentOS, let’s modify the configuration before deploying the plugin.</p>
<p>Download the <code class="docutils literal notranslate"><span class="pre">calico</span></code> configuration:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>curl<span class="w"> </span>-fOSsL<span class="w"> </span>https://docs.projectcalico.org/manifests/calico.yaml
</pre></div>
</div>
<p>And add the following configuration options to the environment section:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">- name: FELIX_IPTABLESBACKEND</span>
<span class="go">  value: &quot;NFT&quot;</span>
</pre></div>
</div>
<p>Save the modified file and then deploy the plugin:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>./calico.yaml
</pre></div>
</div>
<p>After a few minutes, you can see that the networking has been configured:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">NAMESPACE     NAME                                                    READY   STATUS    RESTARTS   AGE</span>
<span class="go">kube-system   calico-kube-controllers-5c6f6b67db-wmts9                1/1     Running   0          99s</span>
<span class="go">kube-system   calico-node-fktnf                                       1/1     Running   0          100s</span>
<span class="go">kube-system   coredns-f9fd979d6-46hmf                                 1/1     Running   0          3m22s</span>
<span class="go">kube-system   coredns-f9fd979d6-v7v4d                                 1/1     Running   0          3m22s</span>
<span class="go">kube-system   etcd-ip-172-31-54-109.ec2.internal                      1/1     Running   0          3m37s</span>
<span class="go">kube-system   kube-apiserver-ip-172-31-54-109.ec2.internal            1/1     Running   0          3m37s</span>
<span class="go">kube-system   kube-controller-manager-ip-172-31-54-109.ec2.internal   1/1     Running   0          3m36s</span>
<span class="go">kube-system   kube-proxy-xd5zg                                        1/1     Running   0          3m22s</span>
<span class="go">kube-system   kube-scheduler-ip-172-31-54-109.ec2.internal            1/1     Running   0          3m36s</span>
</pre></div>
</div>
<p>To verify that networking has been setup successfully, let’s use the <code class="docutils literal notranslate"><span class="pre">multitool</span></code> container:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>kubectl<span class="w"> </span>run<span class="w"> </span>multitool<span class="w"> </span>--image<span class="o">=</span>praqma/network-multitool<span class="w"> </span>--restart<span class="w"> </span>Never
</pre></div>
</div>
<p>and then run a simple <code class="docutils literal notranslate"><span class="pre">ping</span></code> command to ensure that the DNS servers can be detected correctly:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>kubectl<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>multitool<span class="w"> </span>--<span class="w"> </span>bash<span class="w"> </span>-c<span class="w"> </span><span class="s1">&#39;ping google.com&#39;</span>
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">PING google.com (172.217.9.206) 56(84) bytes of data.</span>
<span class="go">64 bytes from iad30s14-in-f14.1e100.net (172.217.9.206): icmp_seq=1 ttl=53 time=0.569 ms</span>
<span class="go">64 bytes from iad30s14-in-f14.1e100.net (172.217.9.206): icmp_seq=2 ttl=53 time=0.548 ms</span>
</pre></div>
</div>
</section>
</section>
</section>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2018-2023, NVIDIA Corporation.
      <span class="lastupdated">Last updated on 2023-04-22.
      </span></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>  

  <style>
  a:link, a:visited {
    color: #76b900;
  }

  a:hover {
    color: #8c0;
  }

  .rst-content dl:not(.docutils) dt {
    background: rgba(118, 185, 0, 0.1);
    color: rgba(59,93,0,1);
    border-top: solid 3px rgba(59,93,0,1);
  }
  </style>
  

</body>
</html>